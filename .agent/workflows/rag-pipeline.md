---
description: RAG 파이프라인 신뢰성 검증 워크플로우
---

# 신뢰 기반 RAG 파이프라인 워크플로우

## 개요
이 워크플로우는 챗봇이 **신뢰할 수 있는 응답**만 제공하도록 보장합니다.
핵심 원칙: "모르면 모른다고 말한다. 거짓말하지 않는다."

---

## RAG 파이프라인 아키텍처

```
사용자 질문
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 1️⃣ 캐시 레이어                                               │
│   ├── Semantic Cache (유사 질문 즉시 응답)                    │
│   └── FAQ Cache (정확 매칭 캐시)                              │
└─────────────────────────────────────────────────────────────┘
    │ 캐시 미스
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 2️⃣ 쿼리 전처리                                               │
│   ├── Query Rewriter (쿼리 확장/정규화)                       │
│   ├── 키워드 추출 (Block A, 학비, CS101 등)                   │
│   └── 다국어 처리 (한국어 ↔ 영어)                             │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 3️⃣ 다중 소스 검색 (신뢰도 점수 포함)                          │
│   ├── LearnedQA (검증된 Q&A) → score: 1.0                    │
│   ├── FAISS 벡터 검색 → score: 1/(1+distance)                │
│   ├── MongoDB Text Search → score: textScore/3.0            │
│   ├── Keyword Regex Search → score: 0.65                    │
│   └── Fuzzy Regex Search → score: 0.45                      │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 4️⃣ 결과 재정렬 (Reranker)                                    │
│   ├── Cross-Encoder 정밀 스코어링                             │
│   └── 최고 점수 결과 선택                                     │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 5️⃣ 신뢰도 판정                                               │
│   ├── confidence >= 0.35 → 데이터 있음 → AI 응답 생성         │
│   └── confidence < 0.35 → NO_DATA → "정보 없음" 응답         │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 6️⃣ 환각 방지 검증                                            │
│   ├── RM 가격 검증 (컨텍스트에 있는지 확인)                   │
│   ├── 날짜/연도 검증                                          │
│   └── 확정적 표현 검증 (NO_DATA인데 확정적이면 차단)          │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 7️⃣ 응답 & 학습                                               │
│   ├── 성공 응답 → Semantic Cache 저장                         │
│   ├── 긍정 피드백 → FAQ Cache 자동 추가                       │
│   └── 부정 피드백 → 개선 대상 기록                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 신뢰성 보장 체크리스트

// turbo-all

### 1. 서버 시작 전 확인
```bash
cd c:\Users\leejb\Desktop\final
python -c "from app.engines.rag_engine import rag_engine; print(f'RAG Enabled: {rag_engine.enabled}')"
```

### 2. MongoDB 연결 확인
```bash
python -c "from app.engines.db_engine import db_engine; print(f'DB Connected: {db_engine.connected}')"
```

### 3. 검색 테스트
```bash
python -c "from app.engines.rag_engine import rag_engine; r = rag_engine.search('Block A'); print(f\"Conf: {r['confidence']}, Has Data: {r['has_relevant_data']}\")"
```

### 4. 서버 시작
```bash
python main.py
```

### 5. API 테스트
```bash
curl -X POST http://localhost:5000/api/chat -H "Content-Type: application/json" -d "{\"message\": \"Where is Block A?\"}"
```

---

## 신뢰도 임계값 설명

| 점수 범위 | 의미 | 동작 |
|-----------|------|------|
| 1.0 | 검증된 답변 (LearnedQA) | 즉시 사용 |
| 0.65+ | 키워드 정확 매칭 | 높은 신뢰도 응답 |
| 0.45-0.64 | 유사 매칭 | 중간 신뢰도 응답 |
| 0.35-0.44 | 약한 매칭 | 주의 필요 |
| < 0.35 | 관련 데이터 없음 | "정보 없음" 응답 |

---

## 환각 방지 규칙

1. **가격 검증**: 응답에 "RM X" 가격이 있으면 컨텍스트에도 있어야 함
2. **날짜 검증**: 특정 연도(2024-2030)는 컨텍스트에 있어야 함
3. **NO_DATA 처리**: 데이터 없으면 반드시 "찾을 수 없습니다" 표현 포함
4. **확정적 표현 차단**: 데이터 없는데 "~입니다"로 답하면 차단

---

## 문제 해결

### "Block A" 같은 쿼리가 검색 안 될 때
1. entity_patterns에 패턴 추가 필요
2. extract_keywords() 함수 확인
3. MongoDB 텍스트 인덱스 확인: `python create_text_index.py`

### 신뢰도가 너무 낮을 때
1. CONFIDENCE_THRESHOLD를 0.30으로 낮추기
2. 검색 필드 확장
3. 동의어 사전 확장 (query_rewriter.py)

### 환각이 감지될 때
1. server.log 확인: `[Hallucination Detected]`
2. validate_response_against_context() 함수 강화
3. 해당 쿼리를 LearnedQA에 추가
